services:
  config-server:
    image: ${DOCKER_USERNAME}/config-server:latest
    container_name: config-server
    ports:
      - "8888:8888"
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
    networks:
      - microservices-net
    # ADDED: Healthcheck to ensure it's actually serving config before others start
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/application/default"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  discovery-server:
    image: ${DOCKER_USERNAME}/discovery-server:latest
    container_name: discovery-server
    ports:
      - "8761:8761"
    depends_on:
      config-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
    networks:
      - microservices-net
    # ADDED: Healthcheck for Eureka
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/"]
      interval: 10s
      timeout: 5s
      retries: 5

  gateway-service:
    image: ${DOCKER_USERNAME}/gateway-service:latest
    container_name: gateway-service
    ports:
      - "8222:8222"
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - microservices-net

  customer-service:
    image: ${DOCKER_USERNAME}/customer-service:latest
    container_name: customer-service
    ports:
      - "8090:8090"
    depends_on:
      mongodb:
        condition: service_healthy
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
      JWT_SECRET: ${JWT_SECRET}
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_DATABASE: customer
      MONGO_AUTH_DB: admin
    networks:
      - microservices-net

  product-service:
    image: ${DOCKER_USERNAME}/product-service:latest
    container_name: product-service
    ports:
      - "8050:8050"
    depends_on:
      postgres:
        condition: service_started # Standard postgres doesn't always have a healthcheck unless defined
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
    networks:
      - microservices-net

  order-service:
    image: ${DOCKER_USERNAME}/order-service:latest
    container_name: order-service
    ports:
      - "8070:8070"
    depends_on:
      postgres:
        condition: service_started
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      GATEWAY_HOST: gateway-service
      GATEWAY_PORT: 8222
    networks:
      - microservices-net

  payment-service:
    image: ${DOCKER_USERNAME}/payment-service:latest
    container_name: payment-service
    ports:
      - "8060:8060"
    depends_on:
      postgres:
        condition: service_started
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - microservices-net

  notification-service:
    image: ${DOCKER_USERNAME}/notification-service:latest
    container_name: notification-service
    ports:
      - "8040:8040"
    depends_on:
      mongodb:
        condition: service_healthy
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      kafka:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
      SPRING_CONFIG_IMPORT: "configserver:http://config-server:8888"
      MONGO_USERNAME: ${MONGO_USERNAME}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      MONGO_DATABASE: customer
      MONGO_AUTH_DB: admin
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      MAIL_HOST: mail-dev
      MAIL_PORT: 1025
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    networks:
      - microservices-net
