name: E-commerce Microservices CI/CD Pipeline

on:
  push:
    branches:
      - master
    paths:
      - 'services/**'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/pipeline.yml'

jobs:
  compile:
    runs-on: ubuntu-latest
    name: Compile all services
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'corretto'

      - name: Compile config-server
        run: |
          cd services/config-server
          mvn clean compile

      - name: Compile discovery-server
        run: |
          cd services/discovery-server
          mvn clean compile

      - name: Compile gateway-service
        run: |
          cd services/gateway-service
          mvn clean compile

      - name: Compile customer-service
        run: |
          cd services/customer-service
          mvn clean compile

      - name: Compile product-service
        run: |
          cd services/product-service
          mvn clean compile

      - name: Compile order-service
        run: |
          cd services/order-service
          mvn clean compile

      - name: Compile payment-service
        run: |
          cd services/payment-service
          mvn clean compile

      - name: Compile notification-service
        run: |
          cd services/notification-service
          mvn clean compile

  unit-tests:
    runs-on: ubuntu-latest
    name: Unit tests
    needs: [compile]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'corretto'

      - name: Run tests - config-server
        run: |
          cd services/config-server
          mvn clean test

      - name: Run tests - discovery-server
        run: |
          cd services/discovery-server
          mvn clean test

      - name: Run tests - gateway-service
        run: |
          cd services/gateway-service
          mvn clean test

      - name: Run tests - customer-service
        run: |
          cd services/customer-service
          mvn clean test

      - name: Run tests - product-service
        run: |
          cd services/product-service
          mvn clean test

      - name: Run tests - order-service
        run: |
          cd services/order-service
          mvn clean test

      - name: Run tests - payment-service
        run: |
          cd services/payment-service
          mvn clean test

      - name: Run tests - notification-service
        run: |
          cd services/notification-service
          mvn clean test

  build-and-push:
    runs-on: ubuntu-latest
    needs: [compile, unit-tests]
    name: Build and Push Docker Images
    outputs:
      config_server_version: ${{ steps.extract_config_version.outputs.version }}
      discovery_server_version: ${{ steps.extract_discovery_version.outputs.version }}
      gateway_service_version: ${{ steps.extract_gateway_version.outputs.version }}
      customer_service_version: ${{ steps.extract_customer_version.outputs.version }}
      product_service_version: ${{ steps.extract_product_version.outputs.version }}
      order_service_version: ${{ steps.extract_order_version.outputs.version }}
      payment_service_version: ${{ steps.extract_payment_version.outputs.version }}
      notification_service_version: ${{ steps.extract_notification_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Extract config-server version
        id: extract_config_version
        run: |
          cd services/config-server
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract discovery-server version
        id: extract_discovery_version
        run: |
          cd services/discovery-server
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract gateway-service version
        id: extract_gateway_version
        run: |
          cd services/gateway-service
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract customer-service version
        id: extract_customer_version
        run: |
          cd services/customer-service
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract product-service version
        id: extract_product_version
        run: |
          cd services/product-service
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract order-service version
        id: extract_order_version
        run: |
          cd services/order-service
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract payment-service version
        id: extract_payment_version
        run: |
          cd services/payment-service
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract notification-service version
        id: extract_notification_version
        run: |
          cd services/notification-service
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build all JAR files
        run: |
          cd services/config-server && mvn clean package -DskipTests && cd ../..
          cd services/discovery-server && mvn clean package -DskipTests && cd ../..
          cd services/gateway-service && mvn clean package -DskipTests && cd ../..
          cd services/customer-service && mvn clean package -DskipTests && cd ../..
          cd services/product-service && mvn clean package -DskipTests && cd ../..
          cd services/order-service && mvn clean package -DskipTests && cd ../..
          cd services/payment-service && mvn clean package -DskipTests && cd ../..
          cd services/notification-service && mvn clean package -DskipTests && cd ../..

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push config-server
        uses: docker/build-push-action@v5
        with:
          context: ./services/config-server
          file: ./services/config-server/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/config-server:${{ steps.extract_config_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/config-server:latest

      - name: Build and Push discovery-server
        uses: docker/build-push-action@v5
        with:
          context: ./services/discovery-server
          file: ./services/discovery-server/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/discovery-server:${{ steps.extract_discovery_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/discovery-server:latest

      - name: Build and Push gateway-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/gateway-service
          file: ./services/gateway-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/gateway-service:${{ steps.extract_gateway_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/gateway-service:latest

      - name: Build and Push customer-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/customer-service
          file: ./services/customer-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/customer-service:${{ steps.extract_customer_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/customer-service:latest

      - name: Build and Push product-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/product-service
          file: ./services/product-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/product-service:${{ steps.extract_product_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/product-service:latest

      - name: Build and Push order-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/order-service
          file: ./services/order-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/order-service:${{ steps.extract_order_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/order-service:latest

      - name: Build and Push payment-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/payment-service
          file: ./services/payment-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/payment-service:${{ steps.extract_payment_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/payment-service:latest

      - name: Build and Push notification-service
        uses: docker/build-push-action@v5
        with:
          context: ./services/notification-service
          file: ./services/notification-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/notification-service:${{ steps.extract_notification_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/notification-service:latest

  deploy:
    name: Deploy to Local Server
    runs-on: self-hosted
    needs: [build-and-push]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment folder (Windows)
        shell: powershell
        run: |
          $deployPath = "$env:USERPROFILE\ecommerce-deployment"
          New-Item -ItemType Directory -Path $deployPath -Force | Out-Null
          Write-Host "Created deployment folder: $deployPath"

      - name: Copy docker-compose file (Windows)
        shell: powershell
        run: |
          $deployPath = "$env:USERPROFILE\ecommerce-deployment"
          Copy-Item "docker-compose.yml" -Destination "$deployPath\docker-compose.yml" -Force
          Write-Host "Copied docker-compose.yml to $deployPath"

      - name: Stop and remove old containers (Windows)
        shell: powershell
        run: |
          $deployPath = "$env:USERPROFILE\ecommerce-deployment"
          Set-Location $deployPath
          Write-Host "Stopping old containers..."
          docker compose down --remove-orphans -ErrorAction SilentlyContinue
          Write-Host "Old containers stopped"

      - name: Pull latest images (Windows)
        shell: powershell
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          $deployPath = "$env:USERPROFILE\ecommerce-deployment"
          Set-Location $deployPath
          Write-Host "Pulling latest images..."
          docker compose pull
          Write-Host "Images pulled successfully"

      - name: Deploy containers (Windows)
        shell: powershell
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          SPRING_PROFILES_ACTIVE: docker
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MONGO_USERNAME: ${{ secrets.MONGO_USERNAME }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          PGADMIN_DEFAULT_EMAIL: ${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD: ${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
        run: |
          $deployPath = "$env:USERPROFILE\ecommerce-deployment"
          Set-Location $deployPath
          Write-Host "Starting containers..."
          docker compose up -d
          Write-Host "Containers started"

      - name: Wait for services to start (Windows)
        shell: powershell
        run: |
          Write-Host "Waiting 15 seconds for services to initialize..."
          Start-Sleep -Seconds 15
          Write-Host "Services starting up..."

      - name: Verify deployment (Windows)
        shell: powershell
        run: |
          Write-Host "Checking running containers..."
          docker ps --filter "label=com.docker.compose.project"
          Write-Host ""

      - name: Check service health (Windows)
        shell: powershell
        run: |
          Write-Host "Checking config-server health..."
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8888/actuator/health" -UseBasicParsing -TimeoutSec 5 -ErrorAction SilentlyContinue
            Write-Host "✅ Config server is healthy"
          } catch {
            Write-Host "⏳ Config server not ready yet"
          }
          
          Write-Host "Checking discovery-server health..."
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8761/actuator/health" -UseBasicParsing -TimeoutSec 5 -ErrorAction SilentlyContinue
            Write-Host "✅ Discovery server is healthy"
          } catch {
            Write-Host "⏳ Discovery server not ready yet"
          }
          
          Write-Host "Checking gateway-service health..."
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8222/actuator/health" -UseBasicParsing -TimeoutSec 5 -ErrorAction SilentlyContinue
            Write-Host "✅ Gateway service is healthy"
          } catch {
            Write-Host "⏳ Gateway service not ready yet"
          }

      - name: Deployment Summary
        shell: powershell
        run: |
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host "✅ Deployment Completed Successfully!" -ForegroundColor Green
          Write-Host "=========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Services URLs:" -ForegroundColor Cyan
          Write-Host "- Config Server:      http://localhost:8888"
          Write-Host "- Discovery Server:   http://localhost:8761"
          Write-Host "- Gateway Service:    http://localhost:8222"
          Write-Host "- Customer Service:   http://localhost:8090"
          Write-Host "- Product Service:    http://localhost:8050"
          Write-Host "- Order Service:      http://localhost:8070"
          Write-Host "- Payment Service:    http://localhost:8060"
          Write-Host "- Notification Service: http://localhost:8040"
          Write-Host ""
          Write-Host "Database Management:" -ForegroundColor Cyan
          Write-Host "- PgAdmin:            http://localhost:5050"
          Write-Host "- Mongo Express:      http://localhost:8081"
          Write-Host "=========================================" -ForegroundColor Green

      - name: Notify deployment status (Success)
        if: success()
        shell: powershell
        run: |
          Write-Host "✅ Deployment successful!" -ForegroundColor Green

      - name: Notify deployment status (Failure)
        if: failure()
        shell: powershell
        run: |
          Write-Host "❌ Deployment failed!" -ForegroundColor Red
          Write-Host "Showing last 50 lines of logs..." -ForegroundColor Yellow
          $deployPath = "$env:USERPROFILE\ecommerce-deployment"
          Set-Location $deployPath
          docker compose logs --tail=50